
```{r}
library(DBI)
library(dplyr)
library(dbplyr)

con1 <- dbConnect(odbc::odbc(),
                       driver = "teradata", DBCName = "sdt01560.labs.teradata.com",
                       uid = "tdwmuser", pwd = "tdwmuser" , database ='tdwmuser')
con <- dbConnect(odbc::odbc(),
                       driver = "teradata", DBCName = "sdt01560.labs.teradata.com",
                       uid = "dbc", pwd = "dbc")

newcon <- dbConnect(odbc::odbc(),
                       driver = "teradata", DBCName = "sdt09398.labs.teradata.com",
                       uid = "dbc", pwd = "dbc")
df1 = tbl(con1,"twm_customer")
head(df1)

glimpse(df1)

colnames(df1)

df1 %>% select (gender,income)

df1 %>% filter(nbr_children > 1 , gender == 'F') %>% select(city_name,income)

df1 %>% select(ends_with(c('come')))

df1 %>% group_by(gender) %>% summarize( avg_income = avg(income)) 

df1 %>% mutate (new_income = income - income *0.25) %>% arrange(desc(income))

Case when, if_else work
df1 = tbl(con1,"twm_customer")  
F_income = df1 %>% group_by(gender) %>% 
  summarise (avg_income = avg(income)) %>% 
  filter( gender == 'F') %>% collect()
M_income = df1 %>% group_by(gender) %>% 
  summarise (avg_income = avg(income)) %>% 
  filter( gender == 'M') %>% 
  collect()

df1 %>%
  mutate(per_income = case_when(
    gender == 'M' ~ income * 0.15,
    gender == 'F' ~ income * 0.25
  )) 

df1 %>%
  mutate(per_income = if_else(
    gender == 'M' , income/M_income$avg_income,income/F_income$avg_income
  )) 


df2 = tbl(con1,"twm_accounts")
inner_join(df1,df2 ,by = 'cust_id')

df4 = tbl(con1,'twm_checking_acct')
inner_join(df2,df4,by = 'cust_id',suffix = c(".x",".y"))

right_join(df2,df4,by = 'cust_id',suffix = c(".x",".y"))

left_join (df2,df4,by = 'cust_id',suffix = c(".x",".y"))

semi_join(df2,df4,by = 'cust_id')

anti_join(df2,df4,by = 'cust_id')

full_join(df2,df4,by = 'cust_id',suffix = c(".x",".y"))

it1 = tbl(con,in_schema("db1","it1"))
d3 = rename (d2,j =grpmarker)

union(d1,d3)

intersect(d1,d3)

setdiff(d1,d3)

system functions and udfs work
time1 = tbl(newcon,in_schema("db1","try1"))
time1 %>% mutate ( new_date = add_months(t,n))

it1 %>% mutate ( res = db1.udf1(i,j))

db1 <- tbl(con,in_schema("db1","boston"))
td_function <- function(df,func_name,pt) {
  qry = paste0(func_name ,"( on " , sql_build(df) ," partition by " , pt ,") as myf")
  qry = build_sql("SELECT * FROM ",sql(qry))
  tbl(con,qry)
}

try1 = db1 %>% td_function("fpftesttblop","ZN")
try1 %>% select("CRIM")

contract = 'library(tdr);
           streamno <- (0);
           integer <- list( datatype="INTEGER_DT", bytesize=4 );
           coldef <- list(avg=integer);
           tdr.SetOutputColDef(streamno, coldef);'

operator = ' library(tdr);
           outHandle <- tdr.Open("W", 0, 0);
           avg <- list ( datatype="INTEGER", value=as.integer(1) , nullIndicator=0 );
           tdr.SetAttributeByNdx(outHandle, 0, avg,NULL);
           tdr.Write(outHandle);
           tdr.Close(outHandle);'

td_execr <- function(data = data,ctrt=ctrt,opr=opr) {
  if (missing(data)) {
    on_clause = "" 
    }
  else {
    on_clause = paste("on",sql_build(data))
  }
  #on = sql_build(data)
  qry = paste0("td_sysgpl.execR (",on_clause," using Contract('",ctrt,"') operator ('",opr,"') ) as r1")
  qry = build_sql("SELECT * FROM ",sql(qry))
  #print(qry)
  tbl(newcon,qry)
  #qry
  
  
}

td_execr(ctrt =contract,opr =operator)

data1 = tbl(newcon,in_schema("db1","t1"))

Contract = '
library(tdr)
on_clause_input_stream <- 0
direction <- "R"
incols <- tdr.GetColDef(on_clause_input_stream, direction)
on_clause_output_stream <- 0
tdr.SetOutputColDef(on_clause_output_stream, incols)'


Operator = 'library(tdr)


streamin <- 0
read_direction <- "R"


streamout <- 0
write_direction <- "W"

options <- 0;
inHandle <- tdr.Open(read_direction, streamin, options);
outHandle <- tdr.Open(write_direction, streamout, options);

numcols <- tdr.GetColCount(streamin, read_direction);

while (tdr.Read(inHandle) == 0)
{
  lapply( 0: (numcols - 1),
          function(index){
            # get and set column attributes
            #att <- tdr.GetAttributeByNdx(inHandle, index, NULL) ;
            #tdr.SetAttributeByNdx(outHandle, index, att, NULL);
            int_max <-as.integer(2147483647);
            value1<-list (datatype="INTEGER", value=int_max,nullIndicator=0 );
            tdr.SetAttributeByNdx(outHandle, index,value1,NULL);

          });
  
  # write row to output
  tdr.Write(outHandle)
};

tdr.Close(inHandle)
tdr.Close(outHandle)'
  
  
td_execr(data=data1,ctrt = Contract,opr=Operator)

con <- dbConnect(odbc::odbc(), Driver = "Teradata", DBCName = "ec2-54-214-75-186.us-west-2.compute.amazonaws.com", UID = "alice", PWD = "alice" , database = "demo")

github_table <- tbl(con, "github")
ngram <- function(t1,text_field) {
  qry <- paste0(" nGram@coprocessor (ON (",sql_render(t1)," ) USING TextColumn ('",text_field,"') Grams ('1-3')) AS Tbl")
  qry = build_sql('SELECT ',sql(text_field),', CAST(ngram AS VARCHAR(4096)) AS ngram, n, frequency',
                  " FROM " , sql(qry))
  #print(qry)
  tbl(con,qry)
}

res1 =  github_table %>% head(10) %>% select (repository_name,repository_description) %>%
ngram("repository_description")

res1

res2 = github_table %>% head(10) %>% filter(repository_watchers == 1) %>% 
  select (repository_name,repository_description) %>%
  ngram("repository_description")

res2
```

